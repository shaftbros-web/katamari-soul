<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>見下ろし型アクションゲーム</title>
<style>
  html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#111;color:#fff;font-family:sans-serif}
  canvas{display:block;touch-action:none}
  #ui{
    position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;
  }
  #title{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    text-align:center;pointer-events:auto;
  }
  button,select,input[type=checkbox]{
    margin:4px;padding:8px;font-size:18px;
  }
  #hud{position:absolute;top:10px;left:10px;pointer-events:none;font-size:18px;}
  #joystick{
    position:absolute;bottom:20px;right:20px;width:120px;height:120px;
    border-radius:50%;background:rgba(255,255,255,0.1);pointer-events:auto;
    touch-action:none;
  }
  #stick{
    position:absolute;width:50px;height:50px;border-radius:50%;
    background:rgba(255,255,255,0.4);left:35px;top:35px;
  }
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="ui">
  <div id="title">
    <h1>見下ろし型アクション</h1>
    <p>仮想スティックで移動。アイテムをくっつけて敵にぶつけて攻撃！</p>
    <div>
      難易度:
      <select id="difficulty">
        <option value="easy">EASY</option>
        <option value="normal" selected>NORMAL</option>
        <option value="hard">HARD</option>
      </select>
    </div>
    <div>
      <label><input type="checkbox" id="shakeToggle" checked>画面シェイクON</label>
      <label><input type="checkbox" id="soundToggle" checked>サウンドON</label>
    </div>
    <button id="startBtn">ゲーム開始</button>
    <p id="hiscore"></p>
  </div>
  <div id="hud" style="display:none;">
    <div id="life">LIFE: 100</div>
    <div id="wave">WAVE: 1</div>
    <div id="score">SCORE: 0</div>
  </div>
  <div id="joystick" style="display:none;"><div id="stick"></div></div>
</div>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
let W,H,DPR;
function resize(){
  DPR=window.devicePixelRatio||1;
  W=window.innerWidth;H=window.innerHeight;
  canvas.width=W*DPR;canvas.height=H*DPR;
  canvas.style.width=W+"px";canvas.style.height=H+"px";
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener("resize",resize);
resize();

// 状態管理
let state="title";
let player,items,enemies,wave,score,life,startTime;
let keys={},joystick={active:false,dx:0,dy:0};
let maxItemsOnScreen=3;
let maxAttach=3;
let difficulty="normal";
let shakeEnabled=true,soundEnabled=true;
let hiscore=localStorage.getItem("hiscore")||0;

// サウンド生成
function beep(freq,dur){
  if(!soundEnabled)return;
  try{
    const ctxA=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctxA.createOscillator();const gain=ctxA.createGain();
    osc.type="square";osc.frequency.value=freq;
    gain.gain.value=0.1;osc.connect(gain);gain.connect(ctxA.destination);
    osc.start();osc.stop(ctxA.currentTime+dur/1000);
  }catch(e){}
}

// エンティティ
class Player{
  constructor(){this.x=W/2;this.y=H/2;this.r=20;this.life=100;this.attached=[];}
  move(dx,dy){this.x+=dx;this.y+=dy;this.x=Math.max(this.r,Math.min(W-this.r,this.x));this.y=Math.max(this.r,Math.min(H-this.r,this.y));}
  draw(){
    ctx.fillStyle="cyan";
    ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fill();
    // 接着アイテム描画
    this.attached.forEach((it,i)=>{
      it.x=this.x+Math.cos(i*2*Math.PI/this.attached.length)*40;
      it.y=this.y+Math.sin(i*2*Math.PI/this.attached.length)*40;
      it.draw();
    });
  }
}
class Item{
  constructor(type,from){
    this.type=type;
    this.hp=(type==="circle"?5:(type==="triangle"?3:2));
    this.attack=(type==="circle"?1:(type==="triangle"?3:2));
    this.knock=(type==="circle"?36:(type==="triangle"?0:12));
    this.r=18;this.attached=false;
    let ang=Math.random()*Math.PI*2;
    let dist=Math.max(W,H)/2+30;
    this.x=W/2+Math.cos(ang)*dist;
    this.y=H/2+Math.sin(ang)*dist;
    this.vx=(W/2-this.x)/200;this.vy=(H/2-this.y)/200;
  }
  update(){
    if(!this.attached){this.x+=this.vx;this.y+=this.vy;}
  }
  draw(){
    ctx.save();
    if(this.type==="circle"){ctx.fillStyle="lime";}
    if(this.type==="triangle"){ctx.fillStyle="orange";}
    if(this.type==="rect"){ctx.fillStyle="violet";}
    ctx.strokeStyle="black";ctx.lineWidth=2;
    ctx.beginPath();
    if(this.type==="circle"){ctx.arc(this.x,this.y,this.r,0,Math.PI*2);}
    if(this.type==="triangle"){
      ctx.moveTo(this.x,this.y-this.r);
      ctx.lineTo(this.x+this.r,this.y+this.r);
      ctx.lineTo(this.x-this.r,this.y+this.r);ctx.closePath();
    }
    if(this.type==="rect"){ctx.rect(this.x-this.r*1.2,this.y-this.r*0.5,this.r*2.4,this.r*0.9);}
    ctx.fill();ctx.stroke();
    ctx.restore();
  }
}
class Enemy{
  constructor(type){
    this.type=type;
    this.r=18;
    this.hp=(type==="boss"?30:(type==="mid"?12:5));
    let ang=Math.random()*Math.PI*2;
    let dist=Math.max(W,H)/2+40;
    this.x=W/2+Math.cos(ang)*dist;
    this.y=H/2+Math.sin(ang)*dist;
    this.vx=(W/2-this.x)/200;this.vy=(H/2-this.y)/200;
  }
  update(){this.x+=this.vx;this.y+=this.vy;}
  draw(){
    ctx.fillStyle=this.type==="boss"?"red":this.type==="mid"?"purple":"gray";
    ctx.strokeStyle="white";ctx.lineWidth=2;
    ctx.beginPath();ctx.arc(this.x,this.y,this.r,0,Math.PI*2);ctx.fill();ctx.stroke();
  }
}

// ゲーム開始
function startGame(){
  player=new Player();
  items=[];enemies=[];
  wave=1;score=0;life=100;
  startTime=Date.now();
  state="game";
  document.getElementById("title").style.display="none";
  document.getElementById("hud").style.display="block";
  document.getElementById("joystick").style.display="block";
}

// メインループ
let shakeX=0,shakeY=0;
function loop(){
  requestAnimationFrame(loop);
  ctx.clearRect(0,0,W,H);

  if(state==="title"){
    ctx.fillStyle="#333";ctx.fillRect(0,0,W,H);
    document.getElementById("hiscore").textContent="ハイスコア:"+hiscore;
    return;
  }
  if(state==="game"){
    // 入力
    let dx=0,dy=0;
    if(keys["ArrowUp"])dy-=3;if(keys["ArrowDown"])dy+=3;
    if(keys["ArrowLeft"])dx-=3;if(keys["ArrowRight"])dx+=3;
    if(joystick.active){dx+=joystick.dx*3;dy+=joystick.dy*3;}
    player.move(dx,dy);

    // 更新
    items.forEach(it=>it.update());
    enemies.forEach(en=>en.update());

    // 衝突判定
    enemies.forEach(en=>{
      // player本体衝突
      let d=Math.hypot(en.x-player.x,en.y-player.y);
      if(d<en.r+player.r){player.life-=1;beep(200,100);}
      // アイテム衝突
      player.attached.forEach(it=>{
        let d2=Math.hypot(en.x-it.x,en.y-it.y);
        if(d2<en.r+it.r){
          en.hp-=it.attack;
          if(it.knock>0){
            en.x+=Math.sign(en.x-player.x)*it.knock;
            en.y+=Math.sign(en.y-player.y)*it.knock;
            if(shakeEnabled&&it.type==="circle"){shakeX=(Math.random()-0.5)*10;shakeY=(Math.random()-0.5)*10;}
          }
          it.hp--;if(it.hp<=0){player.attached=player.attached.filter(x=>x!==it);}
          beep(440,80);
        }
      });
    });
    enemies=enemies.filter(en=>{if(en.hp<=0){score+=10;beep(880,100);return false;}return true;});

    // アイテム吸着
    items.forEach(it=>{
      let d=Math.hypot(it.x-player.x,it.y-player.y);
      if(d<40&&!it.attached&&player.attached.length<maxAttach){
        it.attached=true;player.attached.push(it);beep(660,100);
      }else if(d<120&&!it.attached){ // マグネット
        it.x+=(player.x-it.x)*0.02;
        it.y+=(player.y-it.y)*0.02;
      }
    });
    items=items.filter(it=>!it.attached);

    // スポーン
    if(Math.random()<0.01 && items.length+player.attached.length<maxItemsOnScreen){
      let t=["circle","triangle","rect"][Math.floor(Math.random()*3)];
      items.push(new Item(t));
    }
    if(Math.random()<0.02)enemies.push(new Enemy("small"));

    // 描画
    ctx.save();ctx.translate(shakeX,shakeY);
    player.draw();
    items.forEach(it=>it.draw());
    enemies.forEach(en=>en.draw());
    ctx.restore();
    shakeX=shakeY=0;

    // HUD
    document.getElementById("life").textContent="LIFE:"+player.life;
    document.getElementById("wave").textContent="WAVE:"+wave;
    document.getElementById("score").textContent="SCORE:"+score;
    if(player.life<=0){state="gameover";}
  }
  if(state==="gameover"){
    ctx.fillStyle="black";ctx.fillRect(0,0,W,H);
    ctx.fillStyle="white";ctx.font="40px sans-serif";
    ctx.fillText("GAME OVER",W/2-100,H/2);
    if(score>hiscore){hiscore=score;localStorage.setItem("hiscore",hiscore);}
  }
}
loop();

// 入力イベント
document.addEventListener("keydown",e=>{keys[e.key]=true;});
document.addEventListener("keyup",e=>{keys[e.key]=false;});

// ジョイスティック
const joy=document.getElementById("joystick");
const stick=document.getElementById("stick");
let joyRect;
function updateJoy(e){
  let t=e.touches[0];
  let x=t.clientX-joyRect.left;
  let y=t.clientY-joyRect.top;
  let dx=x-60,dy=y-60;
  let len=Math.hypot(dx,dy);
  if(len>40){dx=dx/len*40;dy=dy/len*40;}
  stick.style.left=(60+dx-25)+"px";
  stick.style.top=(60+dy-25)+"px";
  joystick.dx=dx/40;joystick.dy=dy/40;
}
joy.addEventListener("touchstart",e=>{joyRect=joy.getBoundingClientRect();joystick.active=true;updateJoy(e);});
joy.addEventListener("touchmove",e=>{updateJoy(e);});
joy.addEventListener("touchend",e=>{joystick.active=false;stick.style.left="35px";stick.style.top="35px";});

// ボタン
document.getElementById("startBtn").onclick=()=>{
  difficulty=document.getElementById("difficulty").value;
  shakeEnabled=document.getElementById("shakeToggle").checked;
  soundEnabled=document.getElementById("soundToggle").checked;
  startGame();
};
</script>
</body>
</html>
