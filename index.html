<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>見下ろし型アクションゲーム</title>
<style>
  body { margin:0; overflow:hidden; background:#88cc88; font-family:sans-serif; }
  canvas { display:block; margin:0 auto; background:#88cc88; }
  #ui {
    position:absolute; top:0; left:0; width:100%; height:100%;
    display:flex; flex-direction:column; justify-content:center; align-items:center;
    background:rgba(0,0,0,0.8); color:#fff;
  }
  button { font-size:20px; padding:10px 20px; margin:10px; }
  .slider-group { margin:8px; color:white; font-size:14px; }
  #controls { position:absolute; bottom:20px; right:20px; }
  #stick { width:100px; height:100px; border-radius:50%; background:rgba(255,255,255,0.2); border:2px solid white; position:relative; }
  #handle { width:40px; height:40px; border-radius:50%; background:white; position:absolute; top:30px; left:30px; }
</style>
</head>
<body>
<div id="ui">
  <h1>見下ろし型アクションゲーム</h1>
  <button id="startBtn">ゲーム開始</button>
  <div class="slider-group">
    アイテム最大数: <input type="range" id="itemMaxSlider" min="3" max="15" value="8"> <span id="itemMaxVal">8</span>
  </div>
  <div class="slider-group">
    ノックバック倍率: <input type="range" id="knockbackSlider" min="1" max="10" value="3"> <span id="knockbackVal">3</span>
  </div>
  <div class="slider-group">
    敵ライフ: <input type="range" id="enemyHpSlider" min="1" max="20" value="5"> <span id="enemyHpVal">5</span>
  </div>
  <div class="slider-group">
    アイテム耐久値: <input type="range" id="itemDurSlider" min="1" max="10" value="5"> <span id="itemDurVal">5</span>
  </div>
</div>
<canvas id="gameCanvas"></canvas>
<div id="controls">
  <div id="stick"><div id="handle"></div></div>
</div>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
let W = window.innerWidth, H = window.innerHeight;
canvas.width = W; canvas.height = H;

let gameRunning = false;
let items = [], enemies = [];
let player = {x:W/2,y:H/2,r:20,hp:10};
let joystick = {active:false,dx:0,dy:0};
let itemMax = 8, knockbackRate = 3, enemyHpBase=5, itemDurBase=5;

// UI操作
document.getElementById("itemMaxSlider").oninput=e=>{
  itemMax=parseInt(e.target.value);
  document.getElementById("itemMaxVal").innerText=itemMax;
};
document.getElementById("knockbackSlider").oninput=e=>{
  knockbackRate=parseInt(e.target.value);
  document.getElementById("knockbackVal").innerText=knockbackRate;
};
document.getElementById("enemyHpSlider").oninput=e=>{
  enemyHpBase=parseInt(e.target.value);
  document.getElementById("enemyHpVal").innerText=enemyHpBase;
};
document.getElementById("itemDurSlider").oninput=e=>{
  itemDurBase=parseInt(e.target.value);
  document.getElementById("itemDurVal").innerText=itemDurBase;
};

document.getElementById("startBtn").onclick=()=>{
  document.getElementById("ui").style.display="none";
  startGame();
};

function startGame(){
  gameRunning=true;
  items=[]; enemies=[];
  player={x:W/2,y:H/2,r:20,hp:10};
  spawnEnemy();
  requestAnimationFrame(loop);
}

function spawnEnemy(){
  let side=Math.floor(Math.random()*4);
  let x= side==0?0: side==1?W:Math.random()*W;
  let y= side==2?0: side==3?H:Math.random()*H;
  enemies.push({x,y,r:20,hp:enemyHpBase});
}

function spawnItem(){
  if(items.length>=itemMax) return;
  let side=Math.floor(Math.random()*4);
  let x= side==0?0: side==1?W:Math.random()*W;
  let y= side==2?0: side==3?H:Math.random()*H;
  let type=["circle","triangle","rect"][Math.floor(Math.random()*3)];
  items.push({x,y,r:15,type,hp:itemDurBase});
}

setInterval(()=>{if(gameRunning) spawnEnemy();},3000);
setInterval(()=>{if(gameRunning) spawnItem();},2000);

function loop(){
  if(!gameRunning) return;
  ctx.fillStyle="#88cc88"; ctx.fillRect(0,0,W,H); // 草原背景

  // player移動
  player.x+=joystick.dx*4;
  player.y+=joystick.dy*4;
  player.x=Math.max(player.r,Math.min(W-player.r,player.x));
  player.y=Math.max(player.r,Math.min(H-player.r,player.y));

  // draw player
  ctx.strokeStyle="black"; ctx.fillStyle="blue";
  ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0,Math.PI*2); ctx.fill(); ctx.stroke();

  // draw items
  items.forEach(it=>{
    ctx.strokeStyle="white"; ctx.fillStyle= it.type=="circle"?"cyan":it.type=="triangle"?"yellow":"orange";
    ctx.beginPath();
    if(it.type=="circle"){ctx.arc(it.x,it.y,it.r,0,Math.PI*2);}
    else if(it.type=="triangle"){
      ctx.moveTo(it.x,it.y-it.r); ctx.lineTo(it.x-it.r,it.y+it.r); ctx.lineTo(it.x+it.r,it.y+it.r); ctx.closePath();
    }else{
      ctx.rect(it.x-it.r*1.5,it.y-it.r,it.r*3,it.r*2); // 長方形を長め
    }
    ctx.fill(); ctx.stroke();
  });

  // draw enemies
  enemies.forEach(en=>{
    ctx.strokeStyle="black"; ctx.fillStyle="red";
    ctx.beginPath(); ctx.arc(en.x,en.y,en.r,0,Math.PI*2); ctx.fill(); ctx.stroke();
    // 移動
    let dx=player.x-en.x, dy=player.y-en.y, d=Math.hypot(dx,dy);
    en.x+=dx/d*1.5; en.y+=dy/d*1.5;
    // 当たり判定
    if(d<player.r+en.r){
      player.hp--; en.hp--;
    }
  });

  // update敵ライフ
  enemies.forEach(en=>{
    if(en.hp<=0) en.dead=true;
    else en.r=20*(en.hp/enemyHpBase);
  });
  enemies=enemies.filter(e=>!e.dead);

  requestAnimationFrame(loop);
}

// joystick
const stick=document.getElementById("stick"), handle=document.getElementById("handle");
stick.addEventListener("touchstart",e=>{joystick.active=true;});
stick.addEventListener("touchend",e=>{joystick.active=false; joystick.dx=0; joystick.dy=0; handle.style.left="30px"; handle.style.top="30px";});
stick.addEventListener("touchmove",e=>{
  if(!joystick.active) return;
  let rect=stick.getBoundingClientRect();
  let x=e.touches[0].clientX-rect.left-50, y=e.touches[0].clientY-rect.top-50;
  let d=Math.hypot(x,y); if(d>40){x*=40/d; y*=40/d;}
  joystick.dx=x/40; joystick.dy=y/40;
  handle.style.left=(30+x)+"px"; handle.style.top=(30+y)+"px";
});
</script>
</body>
</html>
