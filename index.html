<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>Stick-On Battle — 安定版(チェーン接着＆KB物理)</title>
<style>
  :root{--panel:#0f1520;--ink:#e6edf3;--muted:#98a2b3}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#0b0f14;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;overscroll-behavior:none}
  #wrap{position:fixed;inset:0}
  canvas{position:absolute;inset:0;width:100vw;height:100vh;touch-action:none}
  .overlay{position:absolute;inset:0;display:grid;place-items:center;background:linear-gradient(#0f1520cc,#0f1520cc);padding:16px}
  .card{width:min(980px,96vw);max-height:92vh;overflow:auto;background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:16px 16px 20px;box-shadow:0 20px 60px rgba(0,0,0,.45)}
  h1{margin:.2em 0;font-size:clamp(22px,4.8vw,36px)}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted);font-size:.95em}
  .btn{appearance:none;border:0;border-radius:12px;background:linear-gradient(180deg,#60a5fa,#2563eb);color:white;padding:12px 16px;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(37,99,235,.35)}
  .btn.secondary{background:#1f2937}
  .btn:active{transform:translateY(1px)}
  label{display:flex;gap:10px;align-items:center;justify-content:space-between;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:10px 12px}
  input[type="range"]{width:240px} select,input[type="checkbox"]{accent-color:#60a5fa}
  .hidden{display:none !important}

  /* HUD */
  #hud{position:absolute;inset:0;pointer-events:none}
  #hudBar{position:absolute;left:10px;top:10px;display:flex;gap:10px;align-items:center}
  #lifeBar{width:200px;height:14px;border:1px solid #334155;border-radius:999px;background:#0b1220;overflow:hidden}
  #lifeFill{height:100%;background:linear-gradient(90deg,#22c55e,#84cc16);width:100%}
  #wave{font-weight:700} #score{font-weight:700;margin-left:8px} #combo{margin-left:8px;color:#fbbf24;font-weight:700}

  /* 仮想スティック（右下固定） */
  #joy{position:absolute;right:12px;bottom:12px;width:min(34vw,200px);height:min(34vw,200px);touch-action:none;pointer-events:auto}
  .joy-base{position:absolute;inset:0;border-radius:50%;border:2px dashed #334155;background:#0b122088}
  .joy-knob{--r:26%;position:absolute;left:50%;top:50%;width:var(--r);height:var(--r);border-radius:50%;transform:translate(-50%,-50%);background:#1f2937;border:2px solid #64748b;box-shadow:0 4px 14px rgba(0,0,0,.45)}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="cv" width="1280" height="720" aria-label="game-canvas"></canvas>

  <!-- HUD -->
  <div id="hud" class="hidden" aria-hidden="true">
    <div id="hudBar">
      <div id="lifeBar"><div id="lifeFill"></div></div>
      <div id="wave">WAVE 1</div>
      <div id="score">SCORE 0</div>
      <div id="combo"></div>
    </div>
  </div>

  <!-- 仮想スティック -->
  <div id="joy" class="hidden" aria-hidden="true">
    <div class="joy-base"></div><div class="joy-knob" id="joyKnob"></div>
  </div>

  <!-- タイトル -->
  <div id="title" class="overlay">
    <div class="card grid">
      <h1>Stick-On Battle — 安定版(チェーン接着＆KB物理)</h1>
      <p class="muted">
        ◯△▭をくっつけて敵にぶつける見下ろしアクション。<br>
        ノックバックは<strong>インパルス物理</strong>で滑らか、画面外へ出ません。<br>
        アイテムは<strong>アイテムにも接続</strong>（チェーン接着）。<br>
        枠色：<b>敵＆プレイヤー=黒 / アイテム=白</b>。
      </p>
      <div class="grid">
        <label>難易度
          <span><select id="difficulty">
              <option value="EASY">EASY</option>
              <option value="NORMAL" selected>NORMAL</option>
              <option value="HARD">HARD</option>
          </select></span>
        </label>
        <label>画面シェイク <span><input id="optShake" type="checkbox" checked></span></label>
        <label>サウンド <span><input id="optSound" type="checkbox"></span></label>

        <label>アイテム総数（画面上） <span><output id="oMaxItem">5</output> 個</span>
          <input id="sMaxItem" type="range" min="3" max="8" step="1" value="5">
        </label>
        <label>敵ライフ倍率 <span><output id="oEnemyHP">1.0</output> x</span>
          <input id="sEnemyHP" type="range" min="0.5" max="3.0" step="0.1" value="1.0">
        </label>
        <label>アイテム耐久倍率 <span><output id="oItemDur">1.0</output> x</span>
          <input id="sItemDur" type="range" min="0.5" max="3.0" step="0.1" value="1.0">
        </label>
        <label>ノックバック倍率 <span><output id="oKBMul">1.0</output> x</span>
          <input id="sKBMul" type="range" min="1" max="10" step="0.1" value="1.0">
        </label>
        <label>敵の出現間隔 <span><output id="oEnemy">900</output> ms</span>
          <input id="sEnemy" type="range" min="250" max="1600" step="50" value="900">
        </label>
        <label>アイテムの出現間隔 <span><output id="oItem">1100</output> ms</span>
          <input id="sItem" type="range" min="600" max="3000" step="50" value="1100">
        </label
