<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>Stick-On Battle — 決定版（確実に開始）</title>
<style>
  :root{--panel:#0f1520;--ink:#e6edf3;--muted:#98a2b3}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#0b0f14;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;overscroll-behavior:none}
  #wrap{position:fixed;inset:0}
  canvas{position:absolute;inset:0;width:100vw;height:100vh;touch-action:none}
  .overlay{position:absolute;inset:0;display:grid;place-items:center;background:linear-gradient(#0f1520cc,#0f1520cc);padding:16px}
  .card{width:min(980px,96vw);max-height:92vh;overflow:auto;background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:16px 16px 20px;box-shadow:0 20px 60px rgba(0,0,0,.45)}
  h1{margin:.2em 0;font-size:clamp(22px,4.8vw,36px)}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted);font-size:.95em}
  .btn{appearance:none;border:0;border-radius:12px;background:linear-gradient(180deg,#60a5fa,#2563eb);color:white;padding:12px 16px;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(37,99,235,.35)}
  .btn.secondary{background:#1f2937}
  .btn:active{transform:translateY(1px)}
  label{display:flex;gap:10px;align-items:center;justify-content:space-between;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:10px 12px}
  input[type="range"]{width:240px} select,input[type="checkbox"]{accent-color:#60a5fa}
  .hidden{display:none !important}

  /* HUD */
  #hud{position:absolute;inset:0;pointer-events:none}
  #hudBar{position:absolute;left:10px;top:10px;display:flex;gap:10px;align-items:center}
  #lifeBar{width:200px;height:14px;border:1px solid #334155;border-radius:999px;background:#0b1220;overflow:hidden}
  #lifeFill{height:100%;background:linear-gradient(90deg,#22c55e,#84cc16);width:100%}
  #wave{font-weight:700} #score{font-weight:700;margin-left:8px} #combo{margin-left:8px;color:#fbbf24;font-weight:700}

  /* 仮想スティック（右下固定） */
  #joy{position:absolute;right:12px;bottom:12px;width:min(34vw,200px);height:min(34vw,200px);touch-action:none;pointer-events:auto}
  .joy-base{position:absolute;inset:0;border-radius:50%;border:2px dashed #334155;background:#0b122088}
  .joy-knob{--r:26%;position:absolute;left:50%;top:50%;width:var(--r);height:var(--r);border-radius:50%;transform:translate(-50%,-50%);background:#1f2937;border:2px solid #64748b;box-shadow:0 4px 14px rgba(0,0,0,.45)}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="cv" width="1280" height="720" aria-label="game-canvas"></canvas>

  <!-- HUD -->
  <div id="hud" class="hidden" aria-hidden="true">
    <div id="hudBar">
      <div id="lifeBar"><div id="lifeFill"></div></div>
      <div id="wave">WAVE 1</div>
      <div id="score">SCORE 0</div>
      <div id="combo"></div>
    </div>
  </div>

  <!-- 仮想スティック -->
  <div id="joy" class="hidden" aria-hidden="true">
    <div class="joy-base"></div><div class="joy-knob" id="joyKnob"></div>
  </div>

  <!-- タイトル：初期表示で必ず出す（ここにスタートボタン） -->
  <div id="title" class="overlay">
    <div class="card grid">
      <h1>Stick-On Battle — 決定版（確実に開始）</h1>
      <p class="muted">
        ◯△▭をくっつけて敵にぶつける見下ろしアクション。<br>
        ノックバックは<strong>インパルス物理</strong>で滑らか、画面外へ出ません。<br>
        アイテムは<strong>アイテムにも接続</strong>（チェーン接着）。<br>
        枠色：<b>敵＆プレイヤー=黒 / アイテム=白</b>。
      </p>
      <div class="grid">
        <label>難易度
          <span><select id="difficulty">
              <option value="EASY">EASY</option>
              <option value="NORMAL" selected>NORMAL</option>
              <option value="HARD">HARD</option>
          </select></span>
        </label>
        <label>画面シェイク <span><input id="optShake" type="checkbox" checked></span></label>
        <label>サウンド <span><input id="optSound" type="checkbox"></span></label>

        <!-- ★ 上限を 15 に拡張 -->
        <label>アイテム総数（画面上） <span><output id="oMaxItem">5</output> 個</span>
          <input id="sMaxItem" type="range" min="3" max="15" step="1" value="5">
        </label>
        <label>敵ライフ倍率 <span><output id="oEnemyHP">1.0</output> x</span>
          <input id="sEnemyHP" type="range" min="0.5" max="3.0" step="0.1" value="1.0">
        </label>
        <label>アイテム耐久倍率 <span><output id="oItemDur">1.0</output> x</span>
          <input id="sItemDur" type="range" min="0.5" max="3.0" step="0.1" value="1.0">
        </label>
        <label>ノックバック倍率 <span><output id="oKBMul">1.0</output> x</span>
          <input id="sKBMul" type="range" min="1" max="10" step="0.1" value="1.0">
        </label>
        <label>敵の出現間隔 <span><output id="oEnemy">900</output> ms</span>
          <input id="sEnemy" type="range" min="250" max="1600" step="50" value="900">
        </label>
        <label>アイテムの出現間隔 <span><output id="oItem">1100</output> ms</span>
          <input id="sItem" type="range" min="600" max="3000" step="50" value="1100">
        </label>
        <label>プレイヤー移動速度 <span><output id="oSpeed">260</output> px/s</span>
          <input id="sSpeed" type="range" min="160" max="380" step="10" value="260">
        </label>
      </div>
      <div class="row">
        <button id="btnStart" class="btn" type="button" aria-label="ゲーム開始">ゲーム開始</button>
        <button id="btnHow" class="btn secondary" type="button">遊び方</button>
      </div>
      <p id="hiscoreLine" class="muted"></p>
    </div>
  </div>

  <!-- 結果オーバーレイ -->
  <div id="gameover" class="overlay hidden" aria-hidden="true">
    <div class="card" style="text-align:center">
      <h2>GAME OVER</h2>
      <p class="muted">もう一度挑戦！</p>
      <div class="row" style="justify-content:center">
        <button id="btnRetry1" class="btn" type="button">タイトルへ</button>
        <button id="btnRestart1" class="btn secondary" type="button">同じ設定で再開</button>
      </div>
    </div>
  </div>
  <div id="clear" class="overlay hidden" aria-hidden="true">
    <div class="card" style="text-align:center">
      <h2>STAGE CLEAR!</h2>
      <pre id="clearStats" class="muted"></pre>
      <div class="row" style="justify-content:center">
        <button id="btnRetry2" class="btn" type="button">タイトルへ</button>
        <button id="btnRestart2" class="btn secondary" type="button">同じ設定で再開</button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================================================
   Stick-On Battle — 決定版（確実に開始）＋ アイテム上限15
========================================================= */
(() => {
  'use strict';

  /* ---------- キャンバス & 背景 ---------- */
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');

  let bgCan=null, bgCtx=null;
  function buildBackground(w,h){
    bgCan=document.createElement('canvas'); bgCan.width=w; bgCan.height=h; bgCtx=bgCan.getContext('2d');
    const g=bgCtx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#114d2c'); g.addColorStop(1,'#1f7a3b');
    bgCtx.fillStyle=g; bgCtx.fillRect(0,0,w,h);
    function srand(i){const x=Math.sin(i*1337.77)*10000; return x-Math.floor(x);}
    bgCtx.globalAlpha=0.14;
    for(let i=0;i<18;i++){
      const px=srand(i+1)*w, py=srand(i+2)*h, rx=120+srand(i+3)*160, ry=60+srand(i+4)*120, ang=srand(i+5)*Math.PI*2;
      bgCtx.save(); bgCtx.translate(px,py); bgCtx.rotate(ang);
      bgCtx.fillStyle=(i%2===0)?'#2aa357':'#0e5e33';
      bgCtx.beginPath(); bgCtx.ellipse(0,0,rx,ry,0,0,Math.PI*2); bgCtx.fill(); bgCtx.restore();
    }
    bgCtx.globalAlpha=1;
    bgCtx.strokeStyle='rgba(255,255,255,0.05)'; bgCtx.lineWidth=1;
    for(let x=0;x<w;x+=40){ bgCtx.beginPath(); bgCtx.moveTo(x,0);
      bgCtx.quadraticCurveTo(x+15,h*0.33,x,h*0.66); bgCtx.quadraticCurveTo(x-15,h*0.83,x,h); bgCtx.stroke(); }
  }
  function fitCanvas(){
    const w=Math.max(1,Math.floor(innerWidth)), h=Math.max(1,Math.floor(innerHeight));
    const dpr=Math.max(1,Math.min(2,devicePixelRatio||1));
    cv.style.width=w+'px'; cv.style.height=h+'px';
    cv.width=Math.floor(w*dpr); cv.height=Math.floor(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    buildBackground(w,h);
  }
  fitCanvas();
  addEventListener('resize', fitCanvas, {passive:true});
  addEventListener('orientationchange', ()=>setTimeout(fitCanvas,100), {passive:true});

  /* ---------- DOM ---------- */
  const hud=document.getElementById('hud');
  const lifeFill=document.getElementById('lifeFill');
  const waveLabel=document.getElementById('wave');
  const scoreLabel=document.getElementById('score');
  const comboLabel=document.getElementById('combo');
  const title=document.getElementById('title');
  const over=document.getElementById('gameover');
  const clear=document.getElementById('clear');
  const joy=document.getElementById('joy');
  const joyKnob=document.getElementById('joyKnob');

  const btnStart=document.getElementById('btnStart');
  const btnHow=document.getElementById('btnHow');
  const btnRetry1=document.getElementById('btnRetry1');
  const btnRestart1=document.getElementById('btnRestart1');
  const btnRetry2=document.getElementById('btnRetry2');
  const btnRestart2=document.getElementById('btnRestart2');

  const difficultySel=document.getElementById('difficulty');
  const optShake=document.getElementById('optShake');
  const optSound=document.getElementById('optSound');

  const sEnemy=document.getElementById('sEnemy'), oEnemy=document.getElementById('oEnemy');
  const sItem=document.getElementById('sItem'), oItem=document.getElementById('oItem');
  const sSpeed=document.getElementById('sSpeed'), oSpeed=document.getElementById('oSpeed');
  const sMaxItem=document.getElementById('sMaxItem'), oMaxItem=document.getElementById('oMaxItem');
  const sEnemyHP=document.getElementById('sEnemyHP'), oEnemyHP=document.getElementById('oEnemyHP');
  const sItemDur=document.getElementById('sItemDur'), oItemDur=document.getElementById('oItemDur');
  const sKBMul=document.getElementById('sKBMul'), oKBMul=document.getElementById('oKBMul');

  const clearStats=document.getElementById('clearStats');
  const hiscoreLine=document.getElementById('hiscoreLine');

  /* ---------- スライダー表示同期 ---------- */
  const bindRange=(r,o,f=(v)=>v)=>{ const sync=()=>o.textContent=f(r.value); r.addEventListener('input',sync,{passive:true}); sync(); };
  bindRange(sEnemy,oEnemy); bindRange(sItem,oItem); bindRange(sSpeed,oSpeed);
  bindRange(sMaxItem,oMaxItem); bindRange(sEnemyHP,oEnemyHP,v=>(+v).toFixed(1));
  bindRange(sItemDur,oItemDur,v=>(+v).toFixed(1)); bindRange(sKBMul,oKBMul,v=>(+v).toFixed(1));

  /* ---------- サウンド ---------- */
  let audioCtx=null;
  function beep(kind='hit'){
    if(!optSound.checked) return;
    try{
      if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type='square'; o.frequency.value=(kind==='hit')?420:(kind==='pickup'?740:(kind==='dead'?220:520));
      g.gain.value=0.08; o.connect(g); g.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime+0.09);
    }catch{}
  }

  /* ---------- 入力（仮想スティック＋キーボード） ---------- */
  const input={x:0,y:0,active:false,id:null,cx:0,cy:0,rad:1};
  function layoutJoystick(){ const r=joy.getBoundingClientRect(); input.cx=r.width/2; input.cy=r.height/2; input.rad=Math.max(30,Math.min(r.width,r.height)*0.38); }
  function stickSet(dx,dy){ const len=Math.hypot(dx,dy), max=input.rad; const nx=len?dx/len:0, ny=len?dy/len:0, mag=Math.min(len,max);
    joyKnob.style.transform=`translate(${nx*mag}px,${ny*mag}px) translate(-50%,-50%)`; input.x=(mag/max)*nx; input.y=(mag/max)*ny; }
  function stickReset(){ input.x=input.y=0; joyKnob.style.transform='translate(-50%,-50%)'; }
  joy.addEventListener('pointerdown',e=>{ if(input.active)return; input.active=true; input.id=e.pointerId; try{joy.setPointerCapture(e.pointerId);}catch{}
    const r=joy.getBoundingClientRect(); stickSet(e.clientX-(r.left+input.cx), e.clientY-(r.top+input.cy)); e.preventDefault();});
  joy.addEventListener('pointermove',e=>{ if(!input.active||e.pointerId!==input.id)return; const r=joy.getBoundingClientRect();
    stickSet(e.clientX-(r.left+input.cx), e.clientY-(r.top+input.cy)); e.preventDefault();});
  function endStick(e){ if(!input.active||(e && e.pointerId!==input.id))return; input.active=false; input.id=null; stickReset(); }
  joy.addEventListener('pointerup',endStick); joy.addEventListener('pointercancel',endStick);

  const keys=new Set(); addEventListener('keydown',e=>{keys.add(e.key.toLowerCase())},{passive:true}); addEventListener('keyup',e=>{keys.delete(e.key.toLowerCase())},{passive:true});

  /* ---------- ユーティリティ ---------- */
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rnd=(a,b)=>a+Math.random()*(b-a);
  const dist2=(ax,ay,bx,by)=>{const dx=ax-bx,dy=ay-by;return dx*dx+dy*dy;}
  const hit=(ax,ay,ar,bx,by,br)=> dist2(ax,ay,bx,by) <= (ar+br)*(ar+br);

  /* ---------- タイプ定義 ---------- */
  const ITEM_TYPES=[
    {k:'CIR',shape:'circle', atk:8,  dur:8, baseR:18, color:'#60a5fa', kb:28}, // 中
    {k:'TRI',shape:'tri',    atk:16, dur:5, baseR:20, color:'#ff80ab', kb:48}, // 大(強)
    {k:'REC',shape:'rect',   atk:12, dur:3, baseR:15, color:'#ffd166', kb: 8, wh:[0.7,4.8]}, // 弱・縦長
  ];
  const ENEMY_TYPES={
    A:{ hp:12,  dmg:10,  spd:70,  baseR:14, color:'#9b59b6'},
    B:{ hp:18,  dmg:12,  spd:100, baseR:12, color:'#e74c3c'},
    C:{ hp:30,  dmg:16,  spd:55,  baseR:18, color:'#f39c12'},
    MID:{hp:120, dmg:20, spd:60,  baseR:28, color:'#16a085'},
    BOSS:{hp:360, dmg:28, spd:70, baseR:34, color:'#e67e22'},
  };
  const DIR8=[[0,-1],[0.707,-0.707],[1,0],[0.707,0.707],[0,1],[-0.707,0.707],[-1,0],[-0.707,-0.707]];
  const WAVES=[
    {name:'WAVE
